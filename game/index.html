/* ============================================================================================
   CONFIGURACIÓ I REFERÈNCIES
   ============================================================================================ */

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const pauseBtn = document.getElementById("pauseBtn");

/* Controls Tàctils (Referència als botons) */
const upBtn = document.getElementById("upBtn");
const downBtn = document.getElementById("downBtn");
const leftBtn = document.getElementById("leftBtn");
const rightBtn = document.getElementById("rightBtn");
const giftBtn = document.getElementById("giftBtn");

/* Variables de Joc */
let estat = "start";
let punts, vides, santa, regals, cases, ocells, efectes;

/* Variables de moviment del Pare Noel */
let isMoving = {
    up: false, down: false, left: false, right: false
};
let isShooting = false;

/* Constants */
const xemeneiaWBase = 25;
const xemeneiaHBase = 25;
const numCases = 5;
let velocitatCasesBase = 3;
let velocitatCases;

/* Comptadors i Decoració */
let encerts;
let combo = 0;
let millorCombo = 0;
let estrelles = [];
let flocsNeu = [];
let skyline = [];

/* ============================================================================================
   FUNCIONS AUXILIARS DE LÒGICA
   ============================================================================================ */

function rgba(r, g, b, a) {
    return `rgba(${r},${g},${b},${a})`;
}

function intersectaRect(r, x, y, w, h) {
    return (
        r.x < x + w && r.x + r.w > x && r.y < y + h && r.y + r.h > y
    );
}

function perdVida(amount = 1) {
    vides -= amount;
    combo = 0;
    if (vides <= 0) {
        vides = 0;
        estat = "gameover";
        actualitzaTextBoto();
    }
}

function actualitzaTextBoto() {
    if (estat === "playing") pauseBtn.textContent = "Pausa";
    else if (estat === "paused") pauseBtn.textContent = "Reprendre";
    else pauseBtn.textContent = "Pausa";
}

function togglePause() {
    if (estat === "playing") estat = "paused";
    else if (estat === "paused") estat = "playing";
    actualitzaTextBoto();
}

/* ============================================================================================
   FUNCIONS DE CREACIÓ I DIBUIX DE MÓN
   ============================================================================================ */

function generaEstrelles() {
    estrelles = [];
    for (let i = 0; i < 120; i++) {
        estrelles.push({
            x: Math.random() * 900, y: Math.random() * 500, r: Math.random() * 1.5 + 0.5
        });
    }
}

function generaNeu() {
    flocsNeu = [];
    for (let i = 0; i < 150; i++) {
        flocsNeu.push({
            x: Math.random() * 900, y: Math.random() * 500, r: Math.random() * 2 + 1, speed: 0.5 + Math.random() * 1.5
        });
    }
}

function generaSkyline() {
    skyline = [];
    let x = 0;
    while (x < 900 + 60) {
        const w = 40 + Math.random() * 40;
        const h = 40 + Math.random() * 80;
        skyline.push({ x, w, h });
        x += w + 10;
    }
}

function dibuixaNit() {
    const grad = ctx.createLinearGradient(0, 0, 0, 500);
    grad.addColorStop(0, "#000814");
    grad.addColorStop(1, "#001d3d");
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, 900, 500);
    ctx.fillStyle = "white";
    for (let s of estrelles) {
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
        ctx.fill();
    }
    ctx.beginPath();
    ctx.arc(900 - 120, 100, 40, 0, Math.PI * 2);
    ctx.fillStyle = "#f5f3c1";
    ctx.fill();
}

function dibuixaSkyline() {
    ctx.fillStyle = "#000918";
    for (let b of skyline) {
        ctx.fillRect(b.x, 500 - b.h, b.w, b.h);
    }
}

function updateNeu() {
    for (let f of flocsNeu) {
        f.y += f.speed;
        if (f.y > 500) {
            f.y = -f.r;
            f.x = Math.random() * 900;
        }
    }
}

function dibuixaNeu() {
    ctx.fillStyle = "#ffffff";
    for (let f of flocsNeu) {
        ctx.beginPath();
        ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
        ctx.fill();
    }
}

function creaCasa(posX) {
    const w = 80 + Math.random() * 60;
    const h = 60 + Math.random() * 60;
    const baseY = 500 - h;
    const colorsCasa = ["#8b4513", "#a0522d", "#6b3e26", "#9c6644"];
    const color = colorsCasa[Math.floor(Math.random() * colorsCasa.length)];
    const chimW = xemeneiaWBase + Math.random() * 10;
    const chimH = xemeneiaHBase + Math.random() * 10;
    const chimX = posX + 20 + Math.random() * (w - 40 - chimW);
    const chimY = baseY - chimH;

    let finestres = [];
    for (let f = 0; f < 2; f++) {
        const numW = 2 + Math.floor(Math.random() * 2);
        for (let i = 0; i < numW; i++) {
            const fw = 20;
            const fh = 22;
            const marginX = 10;
            const marginY = 15;
            const espai = (w - marginX * 2 - fw) / Math.max(1, numW - 1);
            const fx = posX + marginX + i * espai;
            const fy = baseY + marginY + f * (fh + 10);
            const lit = Math.random() < 0.7;
            finestres.push({ x: fx, y: fy, w: fw, h: fh, lit });
        }
    }
    return {
        x: posX, y: baseY, w, h, chimX, chimY, chimW, chimH, color, finestres, completada: false
    };
}

function generaCasesInicials() {
    cases = [];
    let posX = 50;
    for (let i = 0; i < numCases; i++) {
        cases.push(creaCasa(posX));
        posX += 170 + Math.random() * 80;
    }
}

function dibuixaVides() {
    ctx.font = "24px Arial";
    for (let i = 0; i < 5; i++) {
        const posX = 900 - 30 - i * 30;
        const posY = 35;
        if (vides >= i + 1) ctx.fillStyle = "red";
        else if (vides >= i + 0.5) ctx.fillStyle = "pink";
        else ctx.fillStyle = "rgba(255,255,255,0.2)";
        ctx.fillText((vides >= i + 1) ? "❤" : "♡", posX, posY);
    }
    ctx.font = "18px Arial";
    ctx.textAlign = "center";
    ctx.fillStyle = combo >= 3 ? "#ffeb3b" : "white";
    ctx.fillText("Racha: " + combo, 900 / 2, 28);
    ctx.textAlign = "left";
}

function dibuixaCases() {
    for (let c of cases) {
        ctx.fillStyle = c.color;
        ctx.fillRect(c.x, c.y, c.w, c.h);
        ctx.fillStyle = "#4a2f19";
        ctx.beginPath();
        ctx.moveTo(c.x, c.y);
        ctx.lineTo(c.x + c.w / 2, c.y - 20);
        ctx.lineTo(c.x + c.w, c.y);
        ctx.closePath();
        ctx.fill();
        ctx.fillStyle = "#333";
        ctx.fillRect(c.chimX, c.chimY, c.chimW, c.chimH);
        ctx.fillStyle = "#5c3a21";
        const pw = 24, ph = 36;
        ctx.fillRect(c.x + c.w / 2 - pw / 2, c.y + c.h - ph, pw, ph);
        for (let f of c.finestres) {
            ctx.fillStyle = f.lit ? "#ffd966" : "#1f2933";
            ctx.fillRect(f.x, f.y, f.w, f.h);
            ctx.strokeStyle = "#000";
            ctx.strokeRect(f.x, f.y, f.w, f.h);
            ctx.beginPath();
            ctx.moveTo(f.x + f.w/2, f.y);
            ctx.lineTo(f.x + f.w/2, f.y + f.h);
            ctx.moveTo(f.x, f.y + f.h/2);
            ctx.lineTo(f.x + f.w, f.y + f.h/2);
            ctx.stroke();
        }
        const cols = ["#ff4d4d", "#4dff4d", "#4dc3ff", "#ffff4d"];
        for (let x = c.x + 5; x < c.x + c.w - 5; x += 10) {
            ctx.fillStyle = cols[Math.floor(Math.random() * cols.length)];
            ctx.beginPath();
            ctx.arc(x, c.y - 5, 2, 0, Math.PI * 2);
            ctx.fill();
        }
    }
}

function dibuixaOcells() {
    for (let o of ocells) {
        ctx.fillStyle = "#c0c0c0";
        ctx.fillRect(o.x, o.y + 6, 28, 10);
        ctx.fillStyle = "#e0e0e0";
        ctx.fillRect(o.x + 25, o.y + 4, 10, 10);
        ctx.fillStyle = "#ffcc33";
        ctx.fillRect(o.x + 35, o.y + 7, 6, 4);
        ctx.fillStyle = "#a0a0a0";
        ctx.beginPath();
        ctx.moveTo(o.x + 10, o.y + 6);
        ctx.lineTo(o.x, o.y);
        ctx.lineTo(o.x + 18, o.y + 6);
        ctx.closePath();
        ctx.fill();
    }
}

function dibuixaSantaIRen() {
    ctx.fillStyle = "#b30000";
    ctx.fillRect(santa.x - 8, santa.y + 10, 48, 22);
    ctx.fillStyle = "#ffcc00";
    ctx.beginPath();
    ctx.moveTo(santa.x - 10, santa.y + 32);
    ctx.lineTo(santa.x + 44, santa.y + 32);
    ctx.lineTo(santa.x + 40, santa.y + 36);
    ctx.lineTo(santa.x - 14, santa.y + 36);
    ctx.closePath();
    ctx.fill();
    ctx.fillStyle = "red";
    ctx.fillRect(santa.x + 10, santa.y - 5, 18, 26);
    ctx.fillStyle = "#ffe0bd";
    ctx.fillRect(santa.x + 12, santa.y - 17, 14, 14);
    ctx.fillStyle = "white";
    ctx.fillRect(santa.x + 10, santa.y - 5, 18, 8);
    ctx.fillStyle = "red";
    ctx.fillRect(santa.x + 12, santa.y - 23, 16, 8);
    ctx.fillStyle = "white";
    ctx.fillRect(santa.x + 12, santa.y - 25, 16, 3);
    ctx.beginPath();
    ctx.arc(santa.x + 28, santa.y - 24, 3, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = "#3b2a1a";
    ctx.fillRect(santa.x + 28, santa.y, 12, 18);
    const renX = santa.x + santa.w + 30;
    const renY = santa.y + 4;
    ctx.fillStyle = "#c87f4f";
    ctx.fillRect(renX, renY + 6, 40, 14);
    ctx.fillRect(renX + 30, renY - 2, 12, 12);
    ctx.fillRect(renX + 6, renY + 20, 4, 10);
    ctx.fillRect(renX + 24, renY + 20, 4, 10);
    ctx.fillStyle = "#ff6666";
    ctx.fillRect(renX + 40, renY + 4, 4, 4);
    ctx.fillStyle = "#e0c9a6";
    ctx.fillRect(renX + 34, renY - 12, 3, 10);
    ctx.fillRect(renX + 30, renY - 12, 3, 8);
    ctx.strokeStyle = "#cc3300";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(santa.x + santa.w + 5, santa.y + 18);
    ctx.lineTo(renX, renY + 12);
    ctx.stroke();
}

function dibuixaRegals() {
    ctx.fillStyle = "#ffd54f";
    for (let r of regals) {
        ctx.fillRect(r.x, r.y, r.w, r.h);
        ctx.strokeStyle = "#d50000";
        ctx.strokeRect(r.x, r.y, r.w, r.h);
        ctx.beginPath();
        ctx.moveTo(r.x + r.w/2, r.y);
        ctx.lineTo(r.x + r.w/2, r.y + r.h);
        ctx.moveTo(r.x, r.y + r.h/2);
        ctx.lineTo(r.x + r.w, r.y + r.h/2);
        ctx.stroke();
    }
}

function dibuixaEfectes() {
    for (let e of efectes) {
        const alpha = e.life / 20;
        const radius = 8 + (20 - e.life);
        ctx.fillStyle = rgba(255, 255, 0, alpha);
        ctx.beginPath();
        ctx.arc(e.x, e.y, radius, 0, Math.PI * 2);
        ctx.fill();
    }
}

function dibuixaPanell(textLines, subTextLines = []) {
    ctx.fillStyle = "rgba(0,0,0,0.6)";
    ctx.fillRect(0, 0, 900, 500);

    const panelW = 520;
    const panelH = 260;
    const x = (900 - panelW) / 2;
    const y = (500 - panelH) / 2;

    ctx.fillStyle = "rgba(10,20,40,0.95)";
    ctx.strokeStyle = "#ffcc00";
    ctx.lineWidth = 3;

    if (ctx.roundRect) ctx.roundRect(x, y, panelW, panelH, 18);
    else ctx.rect(x, y, panelW, panelH);

    ctx.fill();
    ctx.stroke();

    ctx.textAlign = "center";
    ctx.fillStyle = "#ffdd55";
    ctx.font = "36px Arial";
    ctx.fillText(textLines[0], 900 / 2, y + 55);

    ctx.fillStyle = "white";
    ctx.font = "18px Arial";
    let offset = 95;
    for (let t of textLines.slice(1)) {
        ctx.fillText(t, 900 / 2, y + offset);
        offset += 24;
    }

    ctx.fillStyle = "#a8e6ff";
    for (let t of subTextLines) {
        ctx.fillText(t, 900 / 2, y + offset);
        offset += 22;
    }

    ctx.textAlign = "left";
}

/* ============================================================================================
   FUNCIONS D'INICI I ADAPTABILITAT
   ============================================================================================ */

function resetGame() {
    punts = 0;
    vides = 5;
    santa = { x: 200, y: 110, w: 60, h: 32, speed: 5, angle: 0 };
    regals = []; cases = []; ocells = []; efectes = [];
    velocitatCases = velocitatCasesBase;
    encerts = 0; combo = 0; millorCombo = 0;

    generaCasesInicials();
    generaEstrelles();
    generaNeu();
    generaSkyline();

    document.getElementById("score").innerText = "Punts: " + punts;
    isMoving = { up: false, down: false, left: false, right: false };
    isShooting = false;
}

function resizeCanvas() {
    const controlsHeight = document.getElementById('controls').offsetHeight;
    const containerHeight = document.body.clientHeight - controlsHeight - 20;
    const aspectRatio = 900 / 500;
    
    let newWidth = window.innerWidth;
    let newHeight = newWidth / aspectRatio;

    if (newHeight > containerHeight) {
        newHeight = containerHeight;
        newWidth = newHeight * aspectRatio;
    }
    
    if (newWidth > window.innerWidth) {
        newWidth = window.innerWidth;
        newHeight = newWidth / aspectRatio;
    }

    canvas.width = newWidth;
    canvas.height = newHeight;
    
    const scaleX = canvas.width / 900;
    const scaleY = canvas.height / 500;
    ctx.setTransform(scaleX, 0, 0, scaleY, 0, 0);
}

window.addEventListener('resize', resizeCanvas);

/* ============================================================================================
   CONTROLS DEL JUGADOR
   ============================================================================================ */

function handleTouch(e, isPressed, direction) {
    e.preventDefault();
    if (estat !== "playing" && direction !== "gift") {
         // Si estem en pantalla d'inici, qualsevol botó de moviment inicia el joc
        if (estat === "start" && (direction === "up" || direction === "down" || direction === "left" || direction === "right") && isPressed) {
            resetGame();
            estat = "playing";
            actualitzaTextBoto();
        }
        return;
    }

    if (direction === "gift") {
        if (isPressed && !isShooting) {
            regals.push({
                x: santa.x + santa.w / 2 - 5, y: santa.y + santa.h, w: 10, h: 10
            });
            isShooting = true;
        } else if (!isPressed) {
            isShooting = false;
        }
    } else {
        isMoving[direction] = isPressed;
    }
}

function setupTouchControls() {
    const buttons = [
        { element: upBtn, direction: 'up' }, { element: downBtn, direction: 'down' },
        { element: leftBtn, direction: 'left' }, { element: rightBtn, direction: 'right' },
        { element: giftBtn, direction: 'gift' }
    ];

    buttons.forEach(btn => {
        btn.element.addEventListener("touchstart", (e) => handleTouch(e, true, btn.direction), { passive: false });
        btn.element.addEventListener("touchend", (e) => handleTouch(e, false, btn.direction), { passive: false });
        btn.element.addEventListener("touchcancel", (e) => handleTouch(e, false, btn.direction), { passive: false });
    });
    
    pauseBtn.addEventListener("click", () => {
        if (estat === "playing" || estat === "paused") togglePause();
    });
}

/* ============================================================================================
   UPDATE, DRAW I LOOP PRINCIPAL
   ============================================================================================ */

function update() {
    if (estat !== "playing") return;

    updateNeu();

    if (isMoving.left)  santa.x -= santa.speed;
    if (isMoving.right) santa.x += santa.speed;
    if (isMoving.up)    santa.y -= santa.speed;
    if (isMoving.down)  santa.y += santa.speed;

    santa.x = Math.max(0, Math.min(900 - santa.w, santa.x));
    santa.y = Math.max(10, Math.min(500 - santa.h - 10, santa.y));

    santa.angle += 0.03;
    santa.y += Math.sin(santa.angle) * 0.3;

    for (let r of regals) r.y += 5;
    for (let c of cases) {
        c.x -= velocitatCases; c.chimX -= velocitatCases;
        for (let f of c.finestres) f.x -= velocitatCases;
    }

    cases = cases.filter(c => c.x + c.w > -50);
    let visible = cases.length;
    let maxX = visible ? Math.max(...cases.map(c => c.x + c.w)) : 50;
    while (visible < numCases) {
        maxX += 170 + Math.random() * 80; cases.push(creaCasa(maxX)); visible++;
    }

    for (let c of cases) {
        const casaRect = { x: c.x, y: c.y, w: c.w, h: c.h };
        const teuladaRect = { x: c.x, y: c.y - 20, w: c.w, h: 20 };
        const santaRect = { x: santa.x, y: santa.y, w: santa.w, h: santa.h };
        if (intersectaRect(santaRect, casaRect.x, casaRect.y, casaRect.w, casaRect.h) ||
            intersectaRect(santaRect, teuladaRect.x, teuladaRect.y, teuladaRect.w, teuladaRect.h)) {
            perdVida(vides); break;
        }
    }

    regals = regals.filter(r => {
        let encert = false; let puntsGuanyats = 0;
        for (let c of cases) {
            if (c.completada) continue;
            if (intersectaRect(r, c.chimX, c.chimY, c.chimW, c.chimH)) { encert = true; puntsGuanyats = 2; c.completada = true; efectes.push({ x: r.x + r.w / 2, y: r.y + r.h / 2, life: 20 }); break; }
            const roofX = c.x; const roofY = c.y - 20; const roofW = c.w; const roofH = 20;
            if (intersectaRect(r, roofX, roofY, roofW, roofH) && r.y + r.h <= c.y) { encert = true; puntsGuanyats = 1; c.completada = true; efectes.push({ x: r.x + r.w / 2, y: r.y + r.h / 2, life: 20 }); break; }
        }

        if (encert) {
            punts += puntsGuanyats; encerts++; combo++; if (combo > millorCombo) millorCombo = combo;
            document.getElementById("score").innerText = "Punts: " + punts;
            if (encerts % 5 === 0) velocitatCases += 0.5;
            return false;
        }
        if (r.y >= 500) { perdVida(0.5); return false; }
        return true;
    });

    if (Math.random() < 0.01 && ocells.length < 4) {
        ocells.push({ x: 900 + 40, y: 40 + Math.random() * 250, w: 40, h: 22 });
    }

    ocells = ocells.filter(o => {
        o.x -= velocitatCases;
        const santaRect = { x: santa.x, y: santa.y, w: santa.w, h: santa.h };
        if (intersectaRect(santaRect, o.x, o.y, o.w, o.h)) { perdVida(1); return false; }
        return o.x + o.w > -50;
    });

    efectes.forEach(e => e.life--);
    efectes = efectes.filter(e => e.life > 0);
}

function draw() {
    ctx.save();
    const scaleX = canvas.width / 900;
    const scaleY = canvas.height / 500;
    ctx.setTransform(scaleX, 0, 0, scaleY, 0, 0);

    dibuixaNit(); dibuixaSkyline(); dibuixaNeu(); dibuixaCases(); dibuixaOcells();
    dibuixaSantaIRen(); dibuixaRegals(); dibuixaEfectes(); dibuixaVides();

    if (estat === "start") {
        dibuixaPanell(["Joc del Pare Noel"], ["Utilitza els botons tàctils per moure i llençar regals.", "Evita ocells i cases · Teulada = 1 punt · Xemeneia = 2 punts", "Toca un botó de moviment per començar"]);
    } else if (estat === "paused") {
        dibuixaPanell(["PAUSA"], ["Prem el botó Reprendre per continuar"]);
    } else if (estat === "gameover") {
        dibuixaPanell(["GAME OVER", "Punts: " + punts, "Millor racha: " + millorCombo], ["Refresca la pàgina per tornar a jugar"]);
    }
    
    ctx.restore();
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

// Inicialització: crida al loop i configuració inicial
resizeCanvas(); // Ajusta la mida inicialment
setupTouchControls(); // Configura els listeners dels botons
loop(); // Inicia el bucle
